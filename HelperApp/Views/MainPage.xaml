<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="HelperApp.Views.MainPage"
             Title="Главная"
             BackgroundColor="#1a1a2e">

    <VerticalStackLayout Padding="0" Spacing="0">

        <!-- Header -->
        <Grid
            Padding="20,15"
            ColumnDefinitions="*,Auto"
            BackgroundColor="#2a2a3e"
            ColumnSpacing="15">

            <!-- User Info -->
            <VerticalStackLayout Grid.Column="0" VerticalOptions="Center">
                <Label Text="{Binding FullName}" FontSize="18" FontAttributes="Bold" />
                <Label Text="{Binding Role, StringFormat='Должность: {0}'}" FontSize="14" />
            </VerticalStackLayout>

            <!-- Logout Button -->
            <Button
                Grid.Column="1"
                Text="Выход"
                Command="{Binding LogoutCommand}"
                BackgroundColor="#ff6b6b"
                TextColor="#ffffff"
                FontSize="13"
                CornerRadius="6"
                Padding="15,8"
                VerticalOptions="Center" />

        </Grid>

        <!-- No Network Alert -->
        <Label
            Text="⚠️ Нет подключения к сети"
            TextColor="#ffffff"
            BackgroundColor="#ff6b6b"
            Padding="20,10"
            FontSize="14"
            HorizontalTextAlignment="Center"
            IsVisible="{Binding HasNetwork, Converter={StaticResource InvertedBoolConverter}}" />

        <!-- Refresh Button & Status -->
        <Grid
            Padding="20,10"
            ColumnDefinitions="*,Auto"
            BackgroundColor="#2a2a3e"
            ColumnSpacing="10">

            <Label
                Text="Мои задачи"
                FontSize="16"
                FontAttributes="Bold"
                TextColor="#e0b0ff"
                VerticalOptions="Center" />

            <Button
                Grid.Column="1"
                Text="Обновить"
                Command="{Binding RefreshTasksCommand}"
                IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                BackgroundColor="#7c3aed"
                TextColor="#ffffff"
                FontSize="12"
                CornerRadius="6"
                Padding="12,6" />

        </Grid>

        <!-- Loading Indicator -->
        <ActivityIndicator
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            Color="#7c3aed"
            Margin="0,20,0,0" />

        <!-- Tasks List (Карточки) -->
        <CollectionView
            ItemsSource="{Binding TaskCards}"
            SelectionMode="Single"
            SelectedItem="{Binding SelectedTaskCard, Mode=TwoWay}"
            Margin="0,0,0,0">

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border
                        Padding="15"
                        Margin="10,8,10,0"
                        StrokeThickness="1"
                        Stroke="#3a3a55"
                        BackgroundColor="#2a2a3e"
                        StrokeShape="RoundRectangle 8">

                        <VerticalStackLayout Spacing="10">

                            <!-- Title -->
                            <Label
                                Text="{Binding Title}"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="#e0b0ff"
                                LineBreakMode="WordWrap" />

                            <!-- Subtitle -->
                            <Label
                                Text="{Binding Subtitle}"
                                FontSize="12"
                                TextColor="#b0b0b0"
                                LineBreakMode="WordWrap"
                                IsVisible="{Binding Subtitle, Converter={StaticResource NotNullOrEmptyConverter}}" />

                            <!-- Status / Metric / Date -->
                            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">

                                <Label
                                    Text="{Binding StatusText, StringFormat='Статус: {0}'}"
                                    FontSize="12"
                                    TextColor="#7c3aed"
                                    VerticalOptions="Center" />

                                <Label
                                    Grid.Column="1"
                                    Text="{Binding PrimaryMetric}"
                                    FontSize="12"
                                    TextColor="#ffffff"
                                    FontAttributes="Bold"
                                    VerticalOptions="Center"
                                    IsVisible="{Binding PrimaryMetric, Converter={StaticResource NotNullOrEmptyConverter}}" />

                                <Label
                                    Grid.Column="2"
                                    Text="{Binding CreatedAt, StringFormat='d'}"
                                    FontSize="11"
                                    TextColor="#888888"
                                    VerticalOptions="Center" />

                            </Grid>

                            <!-- Badges -->
                            <FlexLayout
                                BindableLayout.ItemsSource="{Binding Badges}"
                                Direction="Row"
                                Wrap="Wrap"
                                AlignItems="Center"
                                JustifyContent="Start"
                                Margin="0,5,0,0">

                                <BindableLayout.ItemTemplate>
                                    <DataTemplate>
                                        <Frame
                                            Padding="8,4"
                                            Margin="0,0,6,6"
                                            CornerRadius="10"
                                            BorderColor="#3a3a55"
                                            HasShadow="False"
                                            BackgroundColor="#1a2a3e">
                                            <HorizontalStackLayout Spacing="4" Padding="0" Margin="0">
                                                <Label
                                                    Text="{Binding Key, StringFormat='{0}:'}"
                                                    FontSize="10"
                                                    TextColor="#b0b0b0"
                                                    Margin="0"
                                                    VerticalOptions="Center" />
                                                <Label
                                                    Text="{Binding Value}"
                                                    FontSize="10"
                                                    TextColor="#7c3aed"
                                                    FontAttributes="Bold"
                                                    Margin="0"
                                                    VerticalOptions="Center" />
                                            </HorizontalStackLayout>
                                        </Frame>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>

                            </FlexLayout>

                        </VerticalStackLayout>

                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

        <!-- Empty State (без конвертера, по TaskCards.Count) -->
        <StackLayout
            Padding="20"
            VerticalOptions="CenterAndExpand"
            HorizontalOptions="CenterAndExpand"
            IsVisible="False">

            <StackLayout.Triggers>
                <DataTrigger TargetType="StackLayout"
                             Binding="{Binding TaskCards.Count}"
                             Value="0">
                    <Setter Property="IsVisible" Value="True" />
                </DataTrigger>
            </StackLayout.Triggers>

            <Label
                Text="Задач не найдено"
                FontSize="16"
                TextColor="#b0b0b0"
                HorizontalTextAlignment="Center" />
        </StackLayout>

    </VerticalStackLayout>

</ContentPage>
